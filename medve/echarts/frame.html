<!DOCTYPE html>
<html lang="en" xmlns="//www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-Type" content="text/html; charset=utf-8" />
    <meta name="description"
        content="Migration narratives in Europe: Through conversations on public social media @BakamoSocial @FES_EU #EU #Migration #Refugees" />
    <meta name="keywords"
        content="migration immigration europe european union bakamo social friedrich erbert stiftung refugees social media narrative EU dataviz echarts csaladenes dc2 d3js d3" />
    <meta property="og:image"
        content="https://denesdata.github.io/eu-immigration-opinion-map/EU_migration_narratives_Security_Sweden.png" />
    <meta property="og:description"
        content="Migration narratives in Europe: Through conversations on public social media @BakamoSocial @FES_EU #EU #Migration #Refugees" />
    <meta property="og:title" content="Migration narratives in Europe" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="https://www.bakamosocial.com" />
    <meta id='social_meta_url' property="og:url" content="https://www.bakamosocial.com" />
    <meta property="fb:admins" content="bakamo.social" />
    <meta name="twitter:creator" content="@BakamoSocial">
    <title>Migration narratives in Europe</title>
    <link rel="shortcut icon" href="https://www.bakamosocial.com/favicon.ico" />

    <link rel="stylesheet" type="text/css" href="default.css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.0/css/all.css"
        integrity="sha384-Mmxa0mLqhmOeaE8vgOSbKacftZcsNYDjQzuCOm6D02luYSzBG8vpaOykv9lFQ51Y" crossorigin="anonymous">
</head>

<body>
    <div id='title' class='text fade'></div>
    <div id='subtitle' class='text fade'></div>
    <div id="chart"></div>

    <script src="https://www.google.com/jsapi"></script>
    <script src="echarts.min.js"></script>
    <script src="d3-fetch.v1.min.js"></script>
    <script src="d3-selection.v1.min.js"></script>
    <script>
        google.load("visualization", "1");
        google.setOnLoadCallback(init);

        function init() {

            var GSheetID = '1-Ygp1M_nIK-iHq3hqF3qtKNgq6tZHttfzT42_1d_L-E'
            var query_type = 'data'
            var all_data = [];

            function data_lists_to_object_array(data) {
                var dummy = [];
                var keys = data[0]
                for (i = 1; i < data.length; i++) {
                    var d = {};
                    for (j = 0; j < keys.length; j++) {
                        d[keys[j]] = data[i][j];
                    }
                    dummy.push(d);
                }
                return dummy
            }

            function data_to_lists(ColumnNames, DataArray) {
                return [ColumnNames].concat(DataArray)
            }

            function transpose(matrix) {
                return matrix[0].map((col, i) => matrix.map(row => row[i]));
            }

            var query1 = new
                google.visualization.Query("https://docs.google.com/spreadsheet/ccc?key=" + GSheetID);
            query1.setQuery("");
            query1.send(handleQueryResponse1);

            function handleQueryResponse1(response) {
                var data = response.getDataTable();
                var n_col = data.getNumberOfColumns();
                var ColumnNames = []
                var DataArray = new Array(data.getNumberOfRows());

                for (var col = 0; col < n_col; col++) {
                    ColumnNames.push(data.getColumnLabel(col))
                }
                for (var row = 0; row < data.getNumberOfRows(); row++) {
                    DataArray[row] = new Array(n_col);
                    for (var col = 0; col < n_col; col++) {
                        DataArray[row][col] = data.getValue(row, col);
                    }
                }

                all_data = data_to_lists(ColumnNames, DataArray)

                function getCalData(data, date, values) {
                    dummy = []
                    keys = Object.keys(data[date])
                    for (var i = 0; i < keys.length; i++) {
                        d=[data[date][keys[i]]]
                        for (var j=0;j<values.length;j++){ 
                            value=values[j];
                            d.push(data[value][keys[i]])
                        }
                        dummy.push(d)
                    }
                    return dummy
                }

                d3.json("../data/szekelyhon_data.json").then(function (rawdata) {
                    console.log(rawdata)    
                    console.log(getCalData(rawdata, 'date', ['severity']))

                    var dom = document.getElementById("chart");
                    var myChart = echarts.init(dom);
                    var app = {};
                    option = null;

                    option = {
                        tooltip: {},
                        visualMap: {
                            min: 0,
                            max: 3,
                            type: 'piecewise',
                            orient: 'horizontal',
                            left: 'center',
                            top: 65,
                            textStyle: {
                                color: '#000'
                            }
                        },
                        timeline :{
                            data:['2018','2019'],
                            bottom:100,
                        },
                        calendar: {
                            id: 'c1',
                            top: 120,
                            left: 30,
                            right: 30,
                            cellSize: ['auto', 13],
                            range: ['2019'],
                            itemStyle: {
                                normal: { borderWidth: 0.5 }
                            },
                            yearLabel: { show: false }
                        },
                        series: {
                            type: 'heatmap',
                            coordinateSystem: 'calendar',
                            data: getCalData(rawdata, 'date', ['severity'])
                        }
                    };
                    ;
                    if (option && typeof option === "object") {
                        myChart.setOption(option, true);
                    }
                })
            }
        }
    </script>
</body>

</html>