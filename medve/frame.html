<html>

<head>
    <meta charset='utf-8'>
    <link rel="stylesheet" href="js/leaflet.css" crossorigin="" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.0/css/all.css"
        integrity="sha384-Mmxa0mLqhmOeaE8vgOSbKacftZcsNYDjQzuCOm6D02luYSzBG8vpaOykv9lFQ51Y" crossorigin="anonymous">
    <script src="https://www.google.com/jsapi"></script>
    <script src="js/d3-fetch.v1.min.js"></script>
    <script src="js/d3-selection.v1.min.js"></script>
    <script src="js/echarts.min.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/echarts-leaflet.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
    <style>
        @import url(//fonts.googleapis.com/css?family=Lato:300,400,700);

        html,
        body {
            font-family: 'Lato', Calibri, Arial, sans-serif;
            background-color: none;
            font-weight: 400;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            color: rgb(56, 37, 26);
            overflow: hidden;
        }

        a {
            color: rgb(56, 37, 26);
            font-weight: bold;
            text-decoration: none;
        }

        #main {
            width: calc(100% - 350px);
            height: 100%;
            position: fixed;
            top: 0;
            left: 350px;
            border-left: 5px solid #7F7F7F;
        }

        #chart {
            position: absolute;
            left: 0;
            top: 0;
            width: 80%;
            height: 100%;
            opacity: 0.8;
        }

        #chart2 {
            position: absolute;
            right: 0;
            top: 0;
            width: 20%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            border-left: 1px solid #7F7F7F;
        }

        #nav {
            width: 348px;
            height: 100%;
            padding: 0px;
            position: fixed;
            top: 0;
            opacity: 0.9;
            background: #9EA8B1;
            border-right: 2px solid black;
            left: 0px;
        }

        video {
            position: fixed;
            left: -20%;
            top: 0%;
            opacity: 0;
            min-width: 120%;
            min-height: 100%;
            transition: opacity 0.5s;
            -webkit-transition: opacity 0.5s;
        }

        #bga {
            width: 100%;
            height: 80%;
            padding: 0px;
            position: fixed;
            top: 0;
            left: 0px;
            opacity: 0;
            background: linear-gradient(to bottom, rgba(256, 256, 256, 1), rgba(256, 256, 256, 0.2));
        }

        #logo {
            position: absolute;
            left: 15%;
            top: 10px;
        }

        #footer {
            position: absolute;
            left: 0;
            bottom: 0px;
        }

        #mysearch {
            left: 0px;
            width: 100%;
            /* text-shadow: 1px 1px 1px black; */
        }

        #table {
            position: absolute;
            left: 5%;
            top: 150px;
            width: 90%;
            /* text-shadow: 1px 1px 1px black; */
        }

        #image {
            position: absolute;
            left: 0px;
            top: 60px;
            width: 100px;
            height: 73px;
            border: solid 1px rgb(56, 37, 26);
        }

        i {
            width: 25px;
        }

        #search {
            height: 20px;
        }

        #tb {
            z-index: 10;
        }

        #tc {
            padding-bottom: 10px;

        }

        .head {
            font-size: 17px;
            padding-left: 110px;
        }

        #social {
            position: absolute;
            right: 44px;
            bottom: 60px;
            font-size: 24px;
        }

        #navi {
            position: absolute;
            right: 0px;
            top: 8px;
            font-size: 24px;
        }

        #looking {
            position: absolute;
            left: 13px;
            top: 13px;
            font-size: 18px;
        }

        #radar {
            position: absolute;
            left: 15px;
            font-size: 17px;
            bottom: 10px;

        }

        #navi i:hover {
            text-shadow: 1px 1px 3px black;
        }

        #legend {
            position: absolute;
            left: 365px;
            font-size: 17px;
            bottom: 10px;

        }

        #center {
            position: absolute;
            left: 410px;
            font-size: 18px;
            top: 10px;
            color: rgb(83, 56, 40);
            font-weight: bold;
            text-shadow: 1px 1px 1px black;
        }

        #help {
            position: absolute;
            left: 710px;
            font-size: 18px;
            top: 10px;
            color: rgb(83, 56, 40);
            font-weight: bold;
            text-shadow: 1px 1px 1px black;
        }

        #radar a,
        input {
            color: rgb(83, 56, 40);
            text-shadow: 1px 1px 2px black;
        }

        #social a {
            color: rgb(83, 56, 40);
            text-shadow: 1px 1px 3px black;
        }

        #home {
            font-size: 17px;
            background: #fff;
            padding: 5px 0px 5px 5px;
        }

        #home:hover {
            cursor: pointer;
            background: #eee;
        }

        svg text:hover,
        #navi:hover {
            cursor: pointer;
        }

        svg text {
            font-size: 0.9em;
            font-weight: 'bold';
        }

        #myInput {
            /* Do not repeat the icon image */
            width: 100%;
            /* Full-width */
            font-size: 18px;
            /* Increase font-size */
            padding: 12px 20px 8px 40px;
            /* Add some padding */
            /* border: 1px solid #ddd; */
            /* Add a grey border */
            margin-bottom: 15px;
            background-color: rgb(189, 203, 216);
            /* Add some space below the input */
            z-index: 5;
        }

        #myUL {
            /* Remove default list styling */
            list-style-type: none;
            padding: 0;
            margin: 0;
            margin-top: -12px;
            margin-left: 1px;
            display: none;
            position: absolute;
            height: 300px;
            overflow-y: auto;
            width: 99%;
        }

        #myUL li a {
            border: 1px solid #ddd;
            /* Add a border to all links */
            margin-top: -1px;
            /* Prevent double borders */
            background-color: rgb(189, 203, 216);
            /* Grey background color */
            padding: 4px;
            /* Add some padding */
            text-decoration: none;
            /* Remove default text underline */
            font-size: 18px;
            /* Increase the font-size */
            /* Add a black text color */
            display: block;
            text-shadow: 1px 1px 2px black;
            z-index: 5;
            /* Make it into a block element to fill the whole list */
        }

        #myUL li a:hover:not(.header) {
            background-color: #eee;
            /* Add a hover effect to all links, except for headers */
        }
    </style>
    <video loop muted autoplay id='v'>
        <source src="viz/medve.mp4" type="video/mp4">
    </video>
    <div id='bga'></div>
    <div id='nav'>
            <a href='https://szekelydata.csaladen.es/medve' target='_blank'><div id='logo'>
            <img src='viz/szekelydata_medveterkep5.png' width="85%">
        </div></a>
        <div id='footer'>
            <img src='viz/footer_medve4.png' width="100%">
        </div>
        <div id='radar'>
            <a href='radar/' target='_blank'>Medvét láttál? Jelezd a Medveradaron&nbsp;&nbsp;<i
                    class="fas fa-wifi"></i></a>
        </div>
        <div id='table'>
            <div id='mysearch'>
                <input type="text" id="myInput" placeholder="Keresés...">

                <ul id="myUL">
                </ul>
            </div>
            <a id='sourcelink' href='' target='_blank'>
                <img id='image' src='viz/medv.png'>
                <table id='desc'>
                    <tr>
                        <td class='head'><i class="fas fa-clock"></i><b id='date'></b></td>
                    </tr>
                    <tr>
                        <td id='tb' class='head'><i class="fas fa-paw"></i><b id='severity'></b></td>
                    </tr>
                    <tr>
                        <td id='tc' class='head'><i class="fas fa-at"></i><b id='source'></b></td>
                    </tr>
                </table>
            </a>
            <table id='desc2'>
                <tr>
                    <td colspan='1'><b id='title'></b></td>
                </tr>
                <tr>
                    <td colspan='1' id='content'></td>
                </tr>
            </table>
            <div id='navi'>
                <i class="fas fa-caret-left" id='left'></i>
                <i class="fas fa-caret-right" id='right'></i></a>
            </div>
            <div id='looking'>
                <i class="fas fa-search"></i></a>
            </div>
        </div>
        <div id='social'>
            <a href="#" id='fb' class='text'
                onclick="window.open('https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),'facebook-share-dialog','width=626,height=436');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
            <a href='' id='tw' target='_blank' class='text'><i class="fab fa-twitter"></i></a>
        </div>
    </div>

    <div id='main'>
        <div id='chart'></div>
        <div id='chart2'></div>
    </div>
    <div id='center'>Medvetérkép beta</div>
    <div id='help'><a href='https://szekelydata.csaladen.es' target='_blank' title='Leírás'><i class="fas fa-question"></i></div>
    <script>
        google.load("visualization", "1");
        google.setOnLoadCallback(init);
        function init() {

            var GSheetID = '1-Ygp1M_nIK-iHq3hqF3qtKNgq6tZHttfzT42_1d_L-E'
            var query_type = 'data'
            var sheetdata = [];
            var home = [25.82, 46.36];
            var home_center = [25.3, 46.4];

            function data_to_lists(ColumnNames, DataArray) {
                return [ColumnNames].concat(DataArray)
            }

            function data_lists_to_object_array(data) {
                var dummy = [];
                var keys = data[0]
                for (i = 1; i < data.length; i++) {
                    var d = {};
                    for (j = 0; j < keys.length; j++) {
                        d[keys[j]] = data[i][j];
                    }
                    dummy.push(d);
                }
                return dummy
            }

            var query1 = new
                google.visualization.Query("https://docs.google.com/spreadsheet/ccc?key=" + GSheetID);
            query1.setQuery("");
            query1.send(handleQueryResponse1);

            function handleQueryResponse1(response) {
                var data = response.getDataTable();
                var ColumnNames = []
                var n_col = data.getNumberOfColumns()
                var DataArray = new Array(data.getNumberOfRows());

                for (var col = 0; col < n_col; col++) {
                    ColumnNames.push(data.getColumnLabel(col))
                }
                for (var row = 0; row <
                    data.getNumberOfRows(); row++) {
                    DataArray[row] = new Array(n_col);
                    for (var col = 0; col < n_col; col++) {
                        DataArray[row][col] = data.getValue(row, col);
                    }
                }

                sheetdata = data_lists_to_object_array(data_to_lists(ColumnNames, DataArray))

                var s = 0.005; //coordinate randomizer
                var sheet_severity = {
                    'Medvét láttam a környéken': 1,
                    'Állatokra támadt': 2,
                    'Emberre támadt': 3,
                    'Állatokra támadott': 2,
                    'Emberre támadott': 3,
                    'Emberi áldozat': 4,
                    'Medvepolitikai döntés vagy esemény': 0
                }
                var leiras = ['Más esemény',
                    'Medvét láttak',
                    'Állatokra támadt',
                    'Emberre támadt',
                    'Emberáldozat'
                ];
                var colors = ['#35978f', '#80cdc1', '#dfc27d', '#8c510a', '#543005'];


                // console.log(sheetdata)

                function sheet_formatter(data) {
                    var res = [];
                    for (var i = 0; i < data.length; i++) {
                        var d = data[i];
                        if (d['Display'] != 0) {
                            var pt = d['Mikor történt az eset?'].split("/");
                            var dt = pt[1] + '/' + pt[0] + '/' + pt[2];
                            res.push({
                                name: d['Submission ID'],
                                value: (!(d['Pontosabban hol?'][0]) ? home.reverse() : d['Pontosabban hol?']
                                    .split(',').reverse())
                                    .concat([sheet_severity[d['Milyen eseményről van szó?']]])
                                    .concat([leiras[sheet_severity[d['Milyen eseményről van szó?']]]])
                                    .concat({
                                        'geo_loc': d['Melyik település környékén?'].split('\n')[1],
                                        'content': (d['Egyedül volt?'] ?
                                            '<ul><li>' + d['Egyedül volt?'].split('\n').join(', ') : ''
                                        ) +
                                            (d['Közel volt?'] ?
                                                '</li><li>' + 'Távolság: ' + d['Közel volt?'].split('(')[1]
                                                    .replace(')', '') : '') +
                                            (d['Még valami?'] ?
                                                '</li><li>' + d['Még valami?'] : '') +
                                            '</ul>',
                                        'date': dt ?
                                            new Date(Date.parse(dt)) : 'Ismeretlen',
                                        'deaths': '',
                                        'link': 'radar',
                                        'name': d['Submission ID'],
                                        'image': d['Szelfid van róla?'],
                                        'type': 'news',
                                        'source': 'Medveradar',
                                        'severity': sheet_severity[d['Milyen eseményről van szó?']],
                                        'title': (d['Ismert mackó? Van neve vagy ismertető jele?'] ?
                                            d['Ismert mackó? Van neve vagy ismertető jele?'] :
                                            'Ismeretlen medve')
                                    })
                            });
                        }
                    }
                    return res;
                }

                sheetdata = sheet_formatter(sheetdata)

                // console.log(sheetdata)

                d3.json("data/szekelyhon_data.json").then(function (rawdata) {

                    // console.log(rawdata)

                    var convertData = function (data) {
                        var res = [];
                        for (var i = 0; i < Object.keys(data.id).length; i++) {
                            var geoCoord = (!data.longitude[i]) ? home : [data.longitude[i], data.latitude[
                                i]];
                            var geoCoord = [geoCoord[0] + (Math.random() - 0.5) * s, geoCoord[1] + (Math
                                .random() - 0.5) * s]
                            var severity = (data.severity[i] == 3) ? ((data
                                .deaths[
                                i] > 0) ? data.severity[i] +
                                1 : data
                                    .severity[i]) : data.severity[i];
                            if (geoCoord) {
                                if (data.relevant[i]) {
                                    if (!(data.duplicate[i])) {
                                        res.push({
                                            name: data.id[i],
                                            value: geoCoord
                                                .concat([severity, leiras[severity]])
                                                .concat({
                                                    'geo_loc': data.geo_loc[i],
                                                    'content': data.content[i],
                                                    'date': new Date(data.date[i]),
                                                    'deaths': data.deaths[i],
                                                    'link': data.link[i],
                                                    'name': data.id[i],
                                                    'image': data.image[i],
                                                    'severity': severity,
                                                    'type': 'news',
                                                    'source': 'Székelyhon',
                                                    'title': data.title[i]
                                                }),
                                        });
                                    }
                                }
                            }
                        }
                        return res;
                    };


                    var data = convertData(rawdata);
                    var z = 4; //index of params
                    var year = '2019';
                    var minyear = '2006';
                    var zoom = [60, 100]

                    // console.log(data)

                    function later_than(data, k, t) {
                        var dummy = [];
                        var t = new Date(Date.parse(t));
                        for (var i = 0; i < data.length; i++) {
                            if (data[i].value[k].date > t) {
                                dummy.push(data[i])
                            }
                        }
                        return dummy;
                    }

                    function filter_than(data, k, key, t) {
                        var dummy = [];
                        for (var i = 0; i < data.length; i++) {
                            if (data[i].value[k][key] > t) {
                                dummy.push(data[i])
                            }
                        }
                        return dummy;
                    }

                    var all_data = data.concat(sheetdata)

                    function sortObject(objs, k1, k2, k3) {
                        return objs.sort((a, b) => (a[k1][k2][k3] > b[k1][k2][k3]) ? -1 :
                            ((b[k1][k2][k3] > a[k1][k2][k3]) ? 1 : 0));
                    }

                    var label_dict = {}
                    var coord_dict = {}
                    var data_dict = {}
                    var time_array = []
                    var sorted_data = sortObject(all_data, 'value', z, 'date')

                    for (i = 0; i < sorted_data.length; i++) {
                        label_dict[sorted_data[i]['name']] = i;
                        data_dict[sorted_data[i]['name']] = sorted_data[i];
                        coord_dict[sorted_data[i]['name']] = sorted_data[i]['value'].slice(0, 2)
                        if (sorted_data[i]['value'][z]['date'] >= Date.parse(minyear)) {
                            time_array.push(sorted_data[i]['value'][z]['date'])
                        }
                    }

                    time_array.sort(function (a, b) {
                        return new Date(a.start).getTime() - new Date(b.start).getTime()
                    })
                    var max_time = time_array[0]
                    // var min_time=time_array.reverse()[0]
                    var min_time = new Date(Date.parse(minyear))

                    //init counter
                    var counter = 5;
                    var this_data = sorted_data[counter]['value'][z];

                    var myChart = echarts.init(document.getElementById('chart'));
                    var myChart2 = echarts.init(document.getElementById('chart2'));

                    options = {
                        tooltip: {
                            trigger: 'item',
                            showContent: false
                        },
                        textStyle: {
                            fontFamily: 'Lato'
                        },
                        visualMap: {
                            type: 'piecewise',
                            dimension: 2,
                            show: false,
                            min: 0,
                            max: 4,
                            inverse: true,
                            pieces: [{
                                value: 0,
                                label: leiras[0],
                                color: colors[0]
                            },
                            {
                                value: 1,
                                label: leiras[1],
                                color: colors[1]
                            },
                            {
                                value: 2,
                                label: leiras[2],
                                color: colors[2]
                            },
                            {
                                value: 3,
                                label: leiras[3],
                                color: colors[3]
                            },
                            {
                                value: 4,
                                label: leiras[4],
                                color: colors[4]
                            }
                            ],
                            itemWidth: 30,
                            itemHeight: 20,
                            textStyle: {
                                color: '#533828',
                                fontSize: 16,
                                fontWeight: 'bold'
                            }
                        },
                    }

                    myChart.setOption(options)
                    myChart2.setOption(options)

                    myChart.setOption({
                        leaflet: {
                            // center: [25.4, 46.5],
                            // zoom: 9,
                            height: '100%',
                            roam: true,
                            tiles: [{
                                label: 'Open Street Map',
                                urlTemplate: 'https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png?lang=hu',
                                options: {
                                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, Tiles courtesy of <a href="https://maps.wikimedia.org" target="_blank">Wikimedia</a>'
                                }
                            }]
                        },
                        series: [{
                            id: 'szekelyhon',
                            type: 'scatter',
                            coordinateSystem: 'leaflet',
                            symbolSize: 20,
                            itemStyle: {
                                normal: {
                                    // color: 'red',
                                    borderColor: 'black',
                                    opacity: 0.9
                                }
                            }
                        },
                        {
                            id: 'radar',
                            type: 'scatter',
                            coordinateSystem: 'leaflet',
                            symbolSize: 20,
                            symbol: 'rect',
                            itemStyle: {
                                normal: {
                                    // color: 'blue',
                                    borderColor: 'black',
                                    opacity: 0.9
                                }
                            }
                        },
                        {
                            id: 'eszekelyhon',
                            type: 'effectScatter',
                            coordinateSystem: 'leaflet',
                            symbolSize: 20,
                            // showEffectOn: 'emphasis',
                            rippleEffect: {
                                brushType: 'stroke',

                            },
                            hoverAnimation: true,
                            itemStyle: {
                                normal: {
                                    // color: 'red',
                                    shadowBlur: 4,
                                    shadowColor: '#333',
                                    borderColor: 'black'
                                }
                            },
                            zlevel: 1
                        },
                        {
                            id: 'eradar',
                            type: 'effectScatter',
                            coordinateSystem: 'leaflet',
                            symbolSize: 20,
                            symbol: 'rect',
                            rippleEffect: {
                                brushType: 'stroke',

                            },
                            hoverAnimation: true,
                            itemStyle: {
                                normal: {
                                    // color: 'red',
                                    shadowBlur: 4,
                                    shadowColor: '#333',
                                    borderColor: 'black'
                                }
                            },
                            zlevel: 2
                        },
                        {
                            id: 'infocus',
                            type: 'effectScatter',
                            coordinateSystem: 'leaflet',
                            symbolSize: 25,
                            // showEffectOn: 'emphasis',
                            rippleEffect: {
                                brushType: 'stroke',

                            },
                            hoverAnimation: true,
                            itemStyle: {
                                normal: {
                                    // color: 'red',
                                    shadowBlur: 4,
                                    shadowColor: '#333',
                                    borderColor: 'black'
                                }
                            },
                            zlevel: 3
                        }
                        ]
                    })
                    myChart2.setOption({

                        yAxis: {
                            type: 'time',
                            min: minyear
                        },
                        xAxis: {
                            gridIndex: 0,
                            max: 4,
                            inverse: true,
                            show: false
                        },
                        grid: {
                            left: '50px',
                            bottom: '40px',
                            right: '80px',
                            top: '40px'
                        },
                        dataZoom: [{
                            id: 'dataZoomY',
                            type: 'slider',
                            yAxisIndex: [0],
                            filterMode: 'empty',
                            start: zoom[0],
                            end: zoom[1],
                            right: 30
                        }],
                        series: [{
                            id: 'sc',
                            type: 'scatter',
                            symbolSize: 10,
                            itemStyle: {
                                normal: {
                                    // color: 'red',
                                    borderColor: 'black',
                                    opacity: 0.4
                                }
                            }
                        },
                        {
                            id: 'sc2',
                            type: 'scatter',
                            symbolSize: 10,
                            symbol: 'rect',
                            itemStyle: {
                                normal: {
                                    // color: 'red',
                                    borderColor: 'black',
                                    opacity: 0.4
                                }
                            }
                        }
                        ]
                    });

                    var date_options = {
                        year: "numeric",
                        month: "long",
                        day: "numeric"
                    };

                    function update_labels(d) {

                        counter = label_dict[d.name]
                        console.log(d.name, counter)

                        myChart.setOption({
                            leaflet: {
                                center: coord_dict[d.name],
                                zoom: 12
                            }
                        })

                        d3.select('#myInput')
                            .property('value', d.geo_loc)
                        d3.select('#source')
                            .text(d.source)
                        d3.select('#sourcelink')
                            .attr('href', d.link)
                        d3.select('#date')
                            .text(d.date.toLocaleString("hu-HU", date_options))
                        d3.select('#severity')
                            .text(leiras[d.severity])
                        d3.select('#title')
                            .text(d.title)
                        d3.select('#image')
                            .attr('src', d.image ? d.image : 'viz/medv.png')
                        d3.select('#content')
                            .html(d.content)

                        update_title(d)

                        setTimeout(() => {
                            myChart.setOption({
                                series: [
                                    {
                                        id: 'infocus',
                                        data: [data_dict[d.name]]
                                    }
                                ]
                            })
                        }, 500)
                    }

                    function update_title(d) {
                        // console.log(d)
                        d3.select('#center')
                            .html('<span style="font-size:15px">' + d.title +
                                '</span><br>' + d.geo_loc + ', ' + d.date.toLocaleString("hu-HU",
                                    date_options) +
                                '<br><span style="color:' + colors[d.severity] + '">' + leiras[d
                                    .severity] +
                                '</span>')
                    }

                    function update_data(data, k, toggle, zoom) {
                        diff = Math.abs(max_time - min_time)
                        start = new Date(min_time.getTime() + diff * zoom[0] / 100.0)
                        end = new Date(min_time.getTime() + diff * zoom[1] / 100.0)
                        var dummy = [];
                        for (var i = 0; i < data.length; i++) {
                            if (toggle[data[i].value[k]['severity']]) {
                                this_date = data[i].value[k]['date']
                                if ((this_date <= end) && (this_date >= start)) {
                                    dummy.push(data[i])
                                }
                            }
                        }
                        return dummy;
                    }

                    myChart.on('click', function (event) {
                        // console.log(event)
                        var d = event.data.value[z];
                        update_labels(d)
                    })

                    myChart.on('mouseover', function (event) {
                        // console.log(event)
                        var d = event.data.value[z];
                        update_title(d)
                    })

                    myChart2.on('click', function (event) {
                        // console.log(event)
                        var d = event.data[3].value[z];
                        update_labels(d)
                    })

                    myChart2.on('mouseover', function (event) {
                        // console.log(event)
                        var d = event.data[3].value[z];
                        update_title(d)
                    })

                    myChart2.on('datazoom', function (event) {
                        zoom = [event.start, event.end]
                        update_chart()
                    })

                    d3.select('#left')
                        .on('click', function () {
                            counter = counter - 1;
                            var this_data = sorted_data[counter]['value'][z];
                            update_labels(this_data)
                        })

                    d3.select('#right')
                        .on('click', function () {
                            counter = counter + 1;
                            this_data = sorted_data[counter]['value'][z];
                            update_labels(this_data)
                        })


                    setTimeout(function () {
                        d3.select('#v')
                            .style('opacity', 1)
                    }, 5000)

                    setTimeout(function () {
                        d3.select('#bga')
                            .style('opacity', 1)
                    }, 4000)

                    function get_values(data, key, z, key2, noise) {
                        dummy = [];
                        for (i = 0; i < data.length; i++) {
                            jitter = (Math.random(1) - 0.5) * 0.6
                            dummy.push(data[i][key][z][key2])
                            // if (noise) console.log(jitter)
                        }
                        return dummy
                    }

                    function get_leiras(data, key, z, key2, leiras) {
                        dummy = [];
                        for (i = 0; i < data.length; i++) {
                            dummy.push(leiras[data[i][key][z][key2]])
                        }
                        return dummy
                    }

                    function transpose(matrix) {
                        return matrix[0].map((col, i) => matrix.map(row => row[i]));
                    }

                    function get_names(data, z) {
                        dummy = []
                        for (i = 0; i < data.length; i++) {
                            d = data[i];
                            d[z] = data[i][z]['value']

                            dummy.push({
                                'name': data[i][z][z]['name'],
                                'value': d
                            })
                        }
                        return data
                    }

                    function update_chart() {
                        var data0 = rtoggle[0] ? update_data(data, z, toggle, zoom) : []
                        var data1 = rtoggle[1] ? update_data(sheetdata, z, toggle, zoom) : []
                        myChart.setOption({
                            series: [{
                                id: 'szekelyhon',
                                data: data0
                            }, {
                                id: 'radar',
                                data: data1
                            }, {
                                id: 'eszekelyhon',
                                data: rtoggle[0] ? later_than(update_data(data,
                                    z, toggle, zoom), z,
                                    year) : []
                            }, {
                                id: 'eradar',
                                data: rtoggle[1] ? later_than(update_data(
                                    sheetdata, z, toggle, zoom),
                                    z, year) : []
                            }]
                        })
                        myChart2.setOption({
                            series: [{
                                id: 'sc',
                                data: transpose([get_values(data0, 'value', z,
                                    'severity', true),
                                get_values(data0, 'value', z,
                                    'date', false),
                                get_values(data0, 'value', z,
                                    'severity', false),
                                    data0
                                ])
                            },
                            {
                                id: 'sc2',
                                data: transpose([get_values(data1, 'value', z,
                                    'severity', true),
                                get_values(data1, 'value', z,
                                    'date', false),
                                get_values(data1, 'value', z,
                                    'severity', false),
                                    data1
                                ])
                            }
                            ]
                        })

                        d3.select('#myUL')
                            .selectAll('li')
                            .remove()
                        d3.select('#myUL')
                            .selectAll('li')
                            .data(data0.reverse())
                            .enter()
                            .append('li')
                            .append('a')
                            .attr('href', '#')
                            .text(function (d) {
                                return d.name
                            })
                            .style('color', function (d) {
                                return colors[d.value[z].severity]
                            })
                            .on('click', function (d) {
                                drop = false;
                                d3.select('#myUL')
                                    .style('display', 'none')
                                update_labels(d.value[z])
                            })
                    }



                    d3.select('#main')
                        .on('click', function (d) {
                            drop = false;
                            d3.select('#myUL')
                                .style('display', 'none')
                        })

                    d3.select('#myInput')
                        .on('keyup', myFunction)

                    var drop = false;
                    d3.select('#myInput')
                        .on('click', function (d) {
                            drop = !drop;
                            d3.select('#myUL')
                                .style('display', (drop) ? 'block' : 'none')
                        })


                    function myFunction() {
                        // Declare variables
                        var input, filter, ul, li, a, i, txtValue;
                        input = document.getElementById('myInput');
                        filter = input.value.toUpperCase();
                        ul = document.getElementById("myUL");
                        li = ul.getElementsByTagName('li');

                        // Loop through all list items, and hide those who don't match the search query
                        for (i = 0; i < li.length; i++) {
                            a = li[i].getElementsByTagName("a")[0];
                            txtValue = a.textContent ||
                                a.innerText;
                            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                                li[i].style.display = "";
                            } else {
                                li[i].style.display = "none";
                            }
                        }
                    }

                    var toggle = [true, true, true, true, true];
                    var rtoggle = [true, true];
                    var h = 25;
                    var r = 10;

                    var svg = d3.select('body').append('div').attr('id', 'legend')
                        .append('svg').attr('height', 172).attr('width', 170)

                    svg.selectAll('.cat')
                        .data(toggle)
                        .enter()
                        .append('circle')
                        .attr('class', function (d, i) {
                            return 'cat cat' + i
                        })
                        .style('fill', function (d, i) {
                            return colors[i]
                        })
                        .style('stroke', function (d, i) {
                            return 'black'
                        })
                        .style('stroke-width', function (d, i) {
                            return 1
                        })
                        .attr('cx', r + 1)
                        .attr('cy', function (d, i) {
                            return r + 1 + i * h
                        })
                        .attr('r', r)

                    svg.selectAll('text')
                        .data(toggle)
                        .enter()
                        .append('text')
                        .attr('class', function (d, i) {
                            return 'cat cat' + i
                        })
                        .style('fill', function (d, i) {
                            return colors[i]
                        })
                        .style('stroke', function (d, i) {
                            return 'black'
                        })
                        .style('stroke-width', function (d, i) {
                            return 0.7
                        })
                        .attr('x', 2 * r + 5)
                        .attr('y', function (d, i) {
                            return 1.5 * r + 1 + i * h
                        })
                        .text(function (d, i) {
                            return leiras[i]
                        })
                        .on('click', function (d, i) {
                            toggle[i] = !(toggle[i]);
                            d3.select('.cat' + i).style('opacity', toggle[i] ? 1 : 0.2)
                            update_chart();
                        })

                    svg
                        .append('circle')
                        .attr('class', 'dim dim0')
                        .attr('cx', r + 1)
                        .attr('cy', r + 1 + 5 * h)
                        .attr('r', r)
                        .style('fill', '#9EA8B1')
                        .style('stroke', function (d, i) {
                            return 'black'
                        })
                        .style('stroke-width', function (d, i) {
                            return 1
                        })


                    svg
                        .append('rect')
                        .attr('class', 'dim dim1')
                        .attr('x', 1)
                        .attr('y', 1 + 6 * h)
                        .attr('width', 2 * r)
                        .attr('height', 2 * r)
                        .style('fill', '#9EA8B1')
                        .style('stroke', function (d, i) {
                            return 'black'
                        })
                        .style('stroke-width', function (d, i) {
                            return 1
                        })

                    svg.append('text')
                        .attr('class', 'dim dim0')
                        .style('fill', '#9EA8B1')
                        .style('stroke', function (d, i) {
                            return 'black'
                        })
                        .style('stroke-width', function (d, i) {
                            return 0.7
                        })
                        .attr('x', 2 * r + 5)
                        .attr('y', function (d, i) {
                            return 1.5 * r + 1 + 5 * h
                        })
                        .text(function (d, i) {
                            return 'Hírek'
                        })
                        .on('click', function (d) {
                            i = 0;
                            rtoggle[i] = !(rtoggle[i]);
                            d3.select('.dim' + i).style('opacity', rtoggle[i] ? 1 : 0.2)
                            update_chart();
                        })

                    svg.append('text')
                        .attr('class', 'dim dim1')
                        .style('fill', '#9EA8B1')
                        .style('stroke', function (d, i) {
                            return 'black'
                        })
                        .style('stroke-width', function (d, i) {
                            return 1
                        })
                        .attr('x', 2 * r + 5)
                        .attr('y', function (d, i) {
                            return 1.5 * r + 1 + 6 * h
                        })
                        .text(function (d, i) {
                            return 'Medveradar'
                        })
                        .on('click', function (d) {
                            i = 1;
                            rtoggle[i] = !(rtoggle[i]);
                            d3.select('.dim' + i).style('opacity', rtoggle[i] ? 1 : 0.2)
                            update_chart();
                        })

                    d3.select('.leaflet-control-zoom')
                        .append('div')
                        .attr('id', 'home')
                        .html('<i class="fas fa-home"></i>')
                        .on('click', function () {
                            myChart.setOption({
                                leaflet: {
                                    center: home_center,
                                    zoom: 9
                                }
                            })
                        })


                    //init
                    update_chart();
                    update_labels(this_data)

                    myChart.setOption({
                        leaflet: {
                            center: home_center,
                            zoom: 9
                        }
                    })

                });
            };
        };
    </script>
</body>

</html>